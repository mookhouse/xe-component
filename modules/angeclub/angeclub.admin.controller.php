<?php
/**
 * vi:set sw=4 ts=4 noexpandtab fileencoding=utf-8:
 * @class  angeclubAdminController
 * @author singleview(root@singleview.co.kr)
 * @brief  angeclubAdminController
**/ 
// "PHONE_2"	"COUNT(`PHONE_2`)"
// "01000000000"	"224"
// "01075742379"	"159"
// "0100000000"	"157"
// "00000000000"	"90"
// "01011111111"	"62"
// "0101111111"	"50"
// "0101234567"	"36"
// "01012341234"	"24"
// "01058482576"	"20"
// "000-000-000"	"18"
// "000000000"	"17"
// "010000000"	"17"
// "0102222222"	"17"
// "0101231234"	"14"
// "01022177402"	"14"
// "000-000-0000"	"13"
// "01020681956"	"13"
// "01012345678"	"11"
// "01024739528"	"10"
// "01048401490"	"10"
// "0193460025"	"10"
// "01040534131"	"9"
// "01044553016"	"9"
// "01099952638"	"9"
// "01195381041"	"9"
// "0000000000"	"8"
// "01022222222"	"8"
// "01039565320"	"8"
// "01055555555"	"8"
// "01077488929"	"8"
// "01099999999"	"8"
// "0168057801"	"8"
// "01027137400"	"7"
// "0103333333"	"7"
// "01033333333"	"7"
// "01043107170"	"7"
// "01047442511"	"7"
// "01094749851"	"7"
// "01100000000"	"7"
// "01020473571"	"6"
// "01023620198"	"6"
// "01024943591"	"6"
// "01025295458"	"6"
// "0102767912"	"6"
// "01032629417"	"6"
// "01075628580"	"6"
// "01087727372"	"6"
// "01098833581"	"6"
// "0109999999"	"6"
// "0110000000"	"6"
// "010000000000"	"5"
// "01012121212"	"5"
// "01022886651"	"5"
// "01023232323"	"5"
// "01025609984"	"5"
// "01029255107"	"5"
// "01032926183"	"5"
// "010400000"	"5"
// "01044444444"	"5"
// "01046165404"	"5"
// "01049722927"	"5"
// "01051603271"	"5"
// "01056123513"	"5"
// "01056581551"	"5"
// "01062521963"	"5"
// "01064555847"	"5"
// "01083559980"	"5"
// "01087045766"	"5"
// "01094354915"	"5"
// "01096757897"	"5"
// "01099033612"	"5"
// "01199693717"	"5"
// "0000-000-000"	"4"
// "000000000000"	"4"
// "010-000-0000"	"4"
// "01012311231"	"4"
// "01022311024"	"4"
// "01023015750"	"4"
// "01023182142"	"4"
// "01023422342"	"4"
// "01023786653"	"4"
// "01024409366"	"4"
// "01024470800"	"4"
// "01025654254"	"4"
// "01026240978"	"4"
// "01026244814"	"4"
// "01026875637"	"4"
// "01027220393"	"4"
// "01028580172"	"4"
// "01029098208"	"4"
// "01029319669"	"4"
// "01029547655"	"4"
// "01033241802"	"4"
// "01033973148"	"4"
// "01034652017"	"4"
// "01035501617"	"4"
// "01036776515"	"4"
// "01036945144"	"4"
// "01037772453"	"4"
// "01038885130"	"4"
// "01039162653"	"4"
// "0104000000"	"4"
// "01040396237"	"4"
// "01040768022"	"4"
// "01041721072"	"4"
// "01041939717"	"4"
// "01042705131"	"4"
// "01042836021"	"4"
// "01043532685"	"4"
// "01044569277"	"4"
// "01046166914"	"4"
// "01046464206"	"4"
// "01046681953"	"4"
// "01047359368"	"4"
// "01047899153"	"4"
// "01051673309"	"4"
// "01053234565"	"4"
// "01053399057"	"4"
// "01054550121"	"4"
// "01054943841"	"4"
// "0105555555"	"4"
// "01056687823"	"4"
// "01056872331"	"4"
// "01056912582"	"4"
// "01058179123"	"4"
// "01058506265"	"4"
// "01062890242"	"4"
// "01063048837"	"4"
// "01065203096"	"4"
// "01066774814"	"4"
// "01071575031"	"4"
// "01072785045"	"4"
// "01075537388"	"4"
// "0107777777"	"4"
// "01082779470"	"4"
// "01085552528"	"4"
// "01086650283"	"4"
// "01086896509"	"4"
// "01087220524"	"4"
// "01087752819"	"4"
// "01087971750"	"4"
// "01087983168"	"4"
// "01088351971"	"4"
// "01088690223"	"4"
// "01089090836"	"4"
// "01092047387"	"4"
// "01092280518"	"4"
// "01092413132"	"4"
// "01092534977"	"4"
// "01094159708"	"4"
// "01096018280"	"4"
// "01097679420"	"4"
// "01099634032"	"4"
// "01099903048"	"4"
// "01191826898"	"4"
// "01194026277"	"4"
// "0160000000"	"4"
// "01600000000"	"4"
// "0162971126"	"4"
// "0165119435"	"4"
// "0167503215"	"4"
// "01700000000"	"4"
// "0177663750"	"4"
// "0195306210"	"4"
// "0195467101"	"4"
// "000-0000-0000"	"3"
// "01000000001"	"3"
// "01011112222"	"3"

class angeclubAdminController extends angeclub
{
	/**
	 * @brief initialization
	 **/
	function init() 
	{
	}
/**
 * @brief migrate old table
 */
	public function procAngeclubAdminMigrate()
	{
		$sCommand = strip_tags(Context::get('command'));
		switch($sCommand)
		{
			case 'retrieve_duplicated_mobile':
				echo 'retrieve_duplicated_mobile has been started<BR>';
				$this->_retreiveDuplicatedMobileInfo();
				break;
			case 'cleanup_com_user_by_mobile':
				echo 'retrieve_duplicated_mobile has been started<BR>';
				$this->_buildupCleanupComUserList();
				break;
			case 'migrate_com_user_into_xe_member':
				echo 'migrate_com_user_into_xe_member has been started<BR>';
				$this->_migrateComUserIntoXeMember();
				break;
			case 'migrate_com_user_into_xe_mombox_data_lake':
				echo 'migrate_com_user_into_xe_mombox_data_lake has been started<BR>';
				$this->_migrateComUserIntoXeMomboxDatalake();
				break;
		}
		exit;
	}
/**
 * @brief COM_USER_cleaned 테이블의 
 */
	private function _migrateComUserIntoXeMomboxDatalake()
	{
		echo __FILE__.':'.__LINE__.'<BR>';
		ini_set('memory_limit', '2048M');  // php.ini default 512M
		set_time_limit(720);  // sec
		
		$sSeqLogFilePath = './files/angeclub/xe_mombox_datalake_migrate_seq.txt';
		$sSeqLogFileContent = FileHandler::readFile($sSeqLogFilePath);
		if($sSeqLogFileContent)
			$nCurPage = (int)$sSeqLogFileContent;
		else
			$nCurPage = 1;

		$oArgs = new stdClass();
		$oArgs->page = $nCurPage;
		// $oArgs->NO = 720476;
		$oArgs->list_count = 60000;
		$oRst = executeQueryArray('angeclub.getTmpAdminComUserCleanedPagination', $oArgs);
		unset($oArgs);
		echo count($oRst->data).' records has been detected<BR>';

		$oMemberModel = &getModel('member');
		foreach($oRst->data as $nIdx=>$oComUser)
		{
			echo 'search NO: '.$oComUser->NO.' USER_ID: '.$oComUser->USER_ID.'<BR>';
			$oXeMemberInfo = $oMemberModel->getMemberInfoByUserID($oComUser->USER_ID);
			if(!$oXeMemberInfo->member_srl)
			{
				echo 'inquiry unregistered member alias<BR>';
				$oArgs = new stdClass();
				$oArgs->USER_ID_SOURCE = $oComUser->USER_ID;
				$oAliasRst = executeQueryArray('angeclub.getTmpAdminComUserTransferredByUserId', $oArgs);
				if(count($oAliasRst->data))
					$oXeMemberInfo = $oMemberModel->getMemberInfoByUserID($oAliasRst->data[0]->USER_ID_DEST);
				// echo '<BR>';
				unset($oArgs);
			}
			else
			{
				var_dump($oXeMemberInfo);
				// echo '<BR>';
			}
			
			// 홈페이지 맘박스 신청 내역 추출
			// SELECT adm_ad.ada_name, adm_history_join.adu_id, adm_history_join.adhj_date_request
			// FROM adm_history_join
			// INNER JOIN adm_ad ON adm_ad.ada_idx=adm_history_join.ada_idx
			// WHERE adm_ad.ada_type='exp' AND ada_name LIKE '%맘박스%'
			// ORDER BY adhj_idx;
			if($oXeMemberInfo->member_srl)
			{
				$oDatalakeArgs = new stdClass();
				$oDatalakeArgs->parent_member_srl = $oXeMemberInfo->member_srl;
				$oDatalakeArgs->mobile = $oXeMemberInfo->mobile;
				$oDatalakeArgs->parent_birthday_yyyymmdd = $oXeMemberInfo->birthday;
				$oDatalakeArgs->parent_gender = $oComUser->PHONE_2;
				$oDatalakeArgs->parent_pregnant = $oComUser->PREGNENT_FL;
				$oDatalakeArgs->baby_birth_name = null;
				$oDatalakeArgs->baby_gender = null;
				$oDatalakeArgs->baby_birthday_yyyymmdd = null;
				$oDatalakeArgs->postcode = $oComUser->ZONE_CODE ? $oComUser->ZONE_CODE : $oComUser->ZIP_CODE;
				$oDatalakeArgs->addr = $oComUser->ADDR;
				$oDatalakeArgs->addr_detail = $oComUser->ADDR_DETAIL;
				// $oDatalakeArgs->addr_extra = null;
				$oDatalakeArgs->email_push = $oComUser->EN_ANGE_EMAIL_FL;
				$oDatalakeArgs->sms_push = $oComUser->EN_ANGE_SMS_FL;
				$oDatalakeArgs->post_push = $oComUser->EN_ANGE_ADDR_FL;
				$oDatalakeArgs->sponsor_push = $oComUser->EN_CLUB_SPONSOR_FL;
				// $oDatalakeArgs->content = null; 
				$oDatalakeArgs->regdate = $oComUser->REG_DT;
			}

			// exit;
		}
		unset($oMemberModel);
		unset($oRst);
		exit;
		FileHandler::writeFile($sSeqLogFilePath, ++$nCurPage);
		echo '<BR><BR>succeed!';
	}
/**
 * @brief USER_ID, EMAIL, PHONE_2, NICK_NM을 정제한 COM_USER_cleaned 테이블을 xe_member tbl에 입력함
 */
	private function _migrateComUserIntoXeMember()
	{
		echo __FILE__.':'.__LINE__.'<BR>';
		ini_set('memory_limit', '2048M');  // php.ini default 512M
		set_time_limit(720);  // sec
		
		$sSeqLogFilePath = './files/angeclub/xe_member_migrate_seq.txt';
		$sSeqLogFileContent = FileHandler::readFile($sSeqLogFilePath);
		if($sSeqLogFileContent)
			$nCurPage = (int)$sSeqLogFileContent;
		else
			$nCurPage = 1;

		$oArgs = new stdClass();
		$oArgs->page = $nCurPage;
		// $oArgs->NO = 720476;
		$oArgs->list_count = 60000;
		$oRst = executeQueryArray('angeclub.getTmpAdminComUserCleanedPagination', $oArgs);
		unset($oArgs);
		echo count($oRst->data).' records has been detected<BR>';

		$oAngeclubModel = &getModel('angeclub');
		$oModuleInfo = $oAngeclubModel->getModuleConfig();
		unset($oAngeclubModel);
		$sMemberAddrFieldName = $oModuleInfo->member_addr_field_name;

		foreach($oRst->data as $nIdx=>$oComUser)
		{
			$oInsertRst = $this->_addMemberInfo($oComUser, $sMemberAddrFieldName);
			if(!$oInsertRst->toBool())
			{
				echo 'error occured while xe_member insert!!!<BR>';
				var_Dump($oComUser);
				echo '<BR>';
				var_Dump($oInsertRst);
				exit;
			}
			$nXeMemberSrl = $oInsertRst->get('member_srl');
			unset($oInsertRst);
			echo 'NO: '.$oComUser->NO.' USER_ID: '.$oComUser->USER_ID.' has been migrated to xe_member_srl: '.$nXeMemberSrl.'<BR>';
			// exit;
		}
		unset($oRst);
		// exit;
		FileHandler::writeFile($sSeqLogFilePath, ++$nCurPage);
		echo '<BR><BR>succeed!';
	}
/**
 * add member profile
 * $oMemberController->insertMember($oArgs, true)를 이용하면 너무 느려서 member table에 직접 기록함
 */
	private function _addMemberInfo($oComUserInfo, $sMemberAddrFieldName)
	{
		$oArgs = new stdClass;
		$oArgs->member_srl = getNextSequence();
		$oArgs->user_id = $oComUserInfo->USER_ID;
		$oArgs->mobile = $oComUserInfo->PHONE_2;
		$oArgs->email_address = $oComUserInfo->EMAIL;
		$oArgs->password = $oComUserInfo->PASSWORD;

		$aEmailInfo = explode('@', $oComUserInfo->EMAIL);
		$oArgs->email_id = $aEmailInfo[0];
		$oArgs->email_host = $aEmailInfo[1];
		unset($aEmailInfo);

		$oArgs->user_name = $oComUserInfo->USER_NM;
		$oArgs->nick_name = $oComUserInfo->NICK_NM;
		$oArgs->birthday = $oComUserInfo->BIRTH;

		$oArgs->allow_mailing = 'N';
		$sCleanedRegDt = preg_replace("/[ \:-]/i", "", $oComUserInfo->REG_DT);  // 2012-01-26 21: 수정
		$oArgs->regdate = $sCleanedRegDt.'0101';
		if(strlen($oComUserInfo->FINAL_LOGIN_DT))
		{
			$sCleanedFinalLoginDt = preg_replace("/[ \:-]/i", "", $oComUserInfo->FINAL_LOGIN_DT);  // 2012-01-26 21: 수정
			$oArgs->last_login = $sCleanedFinalLoginDt.'0101';
			$dtChangePasswordDate = new \DateTime($oArgs->last_login.' +60 day');
			$oArgs->change_password_date = $dtChangePasswordDate->format('YmdHis');
		}
		else
		{
			$oArgs->last_login = $oArgs->regdate;
			$dtChangePasswordDate = new \DateTime($oArgs->regdate.' +60 day');
			$oArgs->change_password_date = $dtChangePasswordDate->format('YmdHis');
		}
		
		// 시작 - 주소를 extra var로 변경
		// O:8:"stdClass":3:{s:15:"xe_validator_id";s:20:"modules/member/tpl/1";s:7:"address";a:4:{i:0;s:5:"06307";i:1;s:30:"서울 서울구 서울로 202";i:2;s:19:"각각동 아파트";i:3;s:11:"(서울동)";}s:15:"give_birth_date";s:8:"20221115";}
		$oExtraVarsArgs = new stdClass;
		$oExtraVarsArgs->$sMemberAddrFieldName[0] = $oComUserInfo->ZONE_CODE ? $oComUserInfo->ZONE_CODE : $oComUserInfo->ZIP_CODE;
		$oExtraVarsArgs->$sMemberAddrFieldName[1] = $oComUserInfo->ADDR;
		$oExtraVarsArgs->$sMemberAddrFieldName[2] = $oComUserInfo->ADDR_DETAIL;
		$oExtraVarsArgs->$sMemberAddrFieldName[3] = '';
		// 끝 - 주소를 extra var로 변경

		// Add extra vars after excluding necessary information from all the requested arguments
		// $oExtraVars = delObjectVars($oAllArgs, $oArgs);
		$oArgs->extra_vars = serialize($oExtraVarsArgs);
		unset($oExtraVarsArgs);
		// exit;
		// remove whitespace
		// $aCheckInfos = array('user_id', 'user_name', 'nick_name', 'email_address');
		// foreach($aCheckInfos as $val)
		// {
		// 	if(isset($oArgs->{$val}))
		// 		$oArgs->{$val} = preg_replace('/[\pZ\pC]+/u', '', html_entity_decode($oArgs->{$val}));
		// }
		// $oMemberController = &getController('member');
		// $oRst = $oMemberController->insertMember($oArgs, true);
		// unset($oArgs);
		// var_dump($oRst);
		// exit;
		$oArgs->list_order = -1 * $oArgs->member_srl;
		$oMemberAddRst = executeQuery('member.insertMember', $oArgs);
		$oMemberAddRst->add('member_srl', $oArgs->member_srl);
		// if(!$oMemberAddRst->toBool())
		// {
		// 	var_dump($oMemberAddRst);
		// 	exit;
		// }
		$oGrpAddArgs = new stdClass();
		$oGrpAddArgs->member_srl = $oArgs->member_srl;
		$oGrpAddArgs->group_srl = 2;
		$oGrpAddArgs->site_srl = 0;
		$output = executeQuery('member.addMemberToGroup',$oGrpAddArgs);
		unset($output);
		unset($oGrpAddArgs);
		unset($oArgs);

		return $oMemberAddRst;
	}
/**
 * @brief 
 */
	private function _getRandStr($length = 6, $bAllAhphaNumeric=FALSE) 
	{
		if($bAllAhphaNumeric)
        	$characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
		else
			$characters = 'abcdefghijklmnopqrstuvwxyz';  // 숫자를 발생시키면 핸폰 번호 아이디 postfix에서 혼란스러움, 대문자 불허함
        $charactersLength = strlen($characters);
        $randomString = '';
        for ($i = 0; $i < $length; $i++) {
            $randomString .= $characters[rand(0, $charactersLength - 1)];
        }
        return $randomString;
    }
/**
 * @brief 
 */
	private function _checkUserIdUniqueness($sUserId) 
	{
		$oArg = new stdClass();
		$oArg->USER_ID = $sUserId;
		$oRst = executeQueryArray('angeclub.getTmpAdminComUserByUserId', $oArg);
		if(count($oUserIdRst->data))
			$sFinalUserId = $sUserId.$this->_getRandStr(2);
		else
			$sFinalUserId = $sUserId;
		unset($oArg);
		unset($oRst);
		return $sFinalUserId;
	}
/**
 * @brief 
 * // if(preg_match("/[\xA1-\xFE][\xA1-\xFE]/", $str))  // EUC-KR인 경우
 *	// 	echo "한글포함.";
 *	// else
 *	// 	echo "한글없음";
 *	// $str = iconv("euckr", "utf8", $str);  // euc-kr -> utf-8
 */
	private function _cleanUserId($sUserId, $sEmail, $sMobile) 
	{
		if(strpos($sUserId, '@') !== false) // USER_ID가 이메일이면
		{ 
			$aUserId = explode('@', $sUserId);
			$sUserId = $this->_checkUserIdUniqueness($aUserId[0]);
			unset($aUserId);
		}
		if(preg_match("/[\xE0-\xFF][\x80-\xFF][\x80-\xFF]/", $sUserId)) // USER_ID가 UTF-8 한글이면
		{ 
			$aUserId = explode('@', $sEmail);
			$sUserId = $this->_checkUserIdUniqueness($aUserId[0]);
			unset($aUserId);
		}
		// https://lynmp.com/ko/article/ad811c9dc5oi
		$sUserId = preg_replace("/[ #\&\\%@=\/\\\:;,\.\+'\"\^`~\|\!\?\*$#<>()\[\]\{\}]/i", "", $sUserId);  // -_ 제외한 특수 문자 제거
		if(strlen($sUserId) == 0)
			$sUserId = $sMobile.$this->_getRandStr(2);
		if(!preg_match('/^[0-9a-zA-Z]+([-_0-9a-zA-Z]+)*$/is', $sUserId))  // XE member ID rule
			$sUserId = $sMobile.$this->_getRandStr(2);
		return strtolower($sUserId);
	}
/**
 * @brief XE email 규칙 위반하면 수정
 */
	private function _validateXeEmail($sEmail) 
	{
		if(strlen($sEmail)==0)  // 이메일이 공란이면
			return $this->_getRandStr(7, TRUE).'@e.c';
		
		$sEmail = str_replace(',' , '.', $sEmail); // 상식적인 co,kr 오류만 수정
		$sEmail = str_replace(' ' , '', $sEmail); // 상식적인 빈칸 오류만 수정
		// 그 이상의 이메일 주소 문법 오류는 허위 입력으로 처리함
		if(!preg_match('/^[\w-]+((?:\.|\+|\~)[\w-]+)*@[\w-]+(\.[\w-]+)+$/is', $sEmail))
			return $this->_getRandStr(7, TRUE).'@e.c';
		return $sEmail;
	}
/**
 * @brief ComUserCleaned tbl에 레코드 추가
 */
	private function _insertComUserCleaned($oMemberInfo) 
	{
		// clean addr info
		$oMemberInfo->ZIP_CODE = trim($oMemberInfo->ZIP_CODE);
		$oMemberInfo->ZONE_CODE = trim($oMemberInfo->ZONE_CODE);
		$oMemberInfo->ADDR = trim($oMemberInfo->ADDR);
		$oMemberInfo->ADDR_DETAIL = trim($oMemberInfo->ADDR_DETAIL);
		// clean addr info
	
		$sOriginNick = $oMemberInfo->NICK_NM;
		$oMemberInfo->NICK_NM = preg_replace("/\s+/","", $oMemberInfo->NICK_NM); // 닉네임의 모든 공백 제거
		if(strlen($oMemberInfo->NICK_NM)==0)
			$oMemberInfo->NICK_NM = $this->_getRandStr(7, TRUE);
		$oInsertRst = executeQuery('angeclub.insertTmpAdminComUserCleaned', $oMemberInfo);
		if(!$oInsertRst->toBool())
		{
			if(strpos($oInsertRst->message, "Duplicate entry '' for key 'uniq_NICK_NM'") !== false)
			{
				$oMemberInfo->NICK_NM = $this->_getRandStr(7, TRUE);
				$oInsertRstAgain = executeQuery('angeclub.insertTmpAdminComUserCleaned', $oMemberInfo);
				if(!$oInsertRstAgain->toBool())
				{
					echo 'duplicated user nick name error occured!!!<BR>';
					var_Dump($oMemberInfo);
					echo '<BR>';
					var_Dump($oInsertRstAgain->message);
					exit;
				}
				echo 'duplicated user nick name: '.$sOriginNick.' has been resolved to '.$oMemberInfo->NICK_NM.'<BR>';
				exit;
			}
			elseif(strpos($oInsertRst->message, "Duplicate entry '' for key 'uniq_USER_ID'") !== false)
			{
				$oMemberInfo->USER_ID = $this->_getRandStr(7, TRUE);
				$oInsertRstAgain = executeQuery('angeclub.insertTmpAdminComUserCleaned', $oMemberInfo);
				if(!$oInsertRstAgain->toBool())
				{
					echo 'duplicated user id name error occured!!!<BR>';
					var_Dump($oMemberInfo);
					echo '<BR>';
					var_Dump($oInsertRstAgain->message);
					exit;
				}
				echo 'duplicated user id: '.$sOriginNick.' has been resolved to '.$oMemberInfo->USER_ID.'<BR>';
				exit;
			}
			// exit;
		}
		unset($oInsertRst);
		return;
	}
/**
 * @brief 고유 핸폰 번호 기준으로 COM_USER 테이블 작성
 * NO와 USER_ID는 가장 마지막 회원 정보를 선택하고 중복 레코드는 mapper에 기록함
 * 아이디로 승인할 수 없는 아이디는 변형하고 mapper에 기록함
 * angeadmin4650, angestory, momsfood 아이디를 보존할 수 없는 이유: 중복되면 안되는 angeweb@ange.co.kr이라는 메일주소로 9게의 중복 회원, mook1004 가 보존됨
 */
	private function _buildupCleanupComUserList()
	{
		echo __FILE__.':'.__LINE__.'<BR>';
		ini_set('memory_limit', '2048M');  // php.ini default 512M
		set_time_limit(360);  // sec
		
		// 핸드폰 고유성이 확보된 COM_USER 테이블 구성
		$sSeqLogFilePath = './files/angeclub/com_user_cleanup_seq.txt';
		$sSeqLogFileContent = FileHandler::readFile($sSeqLogFilePath);
		if($sSeqLogFileContent)
			$nCurPage = (int)$sSeqLogFileContent;
		else
			$nCurPage = 1;

		$oArgs = new stdClass();
		$oArgs->page = $nCurPage;
		$oArgs->list_count = 75000;
		$oRst = executeQueryArray('angeclub.getTmpAdminComUserPagination', $oArgs);
		unset($oArgs);
		echo count($oRst->data).' records has been detected<BR>';

		$oArgs = new stdClass();
		$oInsertArgs = new stdClass();
		$aIgnoreMobileNo = ["00000000000", "01011112222", "01012345678", "01012341234", "123123123", 
							"01044444444", "010400000", "01023232323", "01012121212", "010000000000",
							"0110000000", "0109999999", "01100000000", "01033333333", "0103333333",
							"01099999999", "01055555555", "01022222222", "0000000000", "000-000-0000", 
							"0101231234", "0102222222", "010000000", "000000000", "000-000-000", 
							"01058482576", "0101234567", "0101111111", "01011111111", "0100000000", 
							"01075742379", "01000000000", "0107777777", '01700000000', '000-0000-0000',
							"01000000001", "01011112222",
							"01023221128", // cys1128@marveltree.com
							"01027137400" // hacker9100@gmail.com, ilsimx@nate.com
							];
		foreach($oRst->data as $nIdx=>$oUser)
		{
			if(strlen($oUser->PHONE_2) < 9)  // 0101234567
				continue;
			if(in_array($oUser->PHONE_2, $aIgnoreMobileNo))
				continue;

			// echo $oUser->NO.' - '.$oUser->PHONE_2.'<BR>';
			$oArgs->PHONE_2 = $oUser->PHONE_2;
			$oDupRst = executeQueryArray('angeclub.getTmpAdminDuplicatedMobileList', $oArgs);
			$nDuplication = count($oDupRst->data);
			if($nDuplication == 0)  // 핸폰 번호 고유성 확인된 회원 정보를 등록
			{
				// echo '핸폰 번호 고유성 확인된 회원 정보를 등록<BR>';
				$sCleanedUserId = $this->_cleanUserId($oUser->USER_ID, $oUser->EMAIL, $oUser->PHONE_2);
				if($oUser->USER_ID != $sCleanedUserId)  // 최종 처리된 ID가 원본 ID와 다르면 ALIAS에 추가함
				{
					$oTransferArg = new stdClass();
					$oTransferArg->NO_SOURCE = $oUser->NO;
					$oTransferArg->USER_ID_SOURCE = $oUser->USER_ID;
					$oTransferArg->NO_DEST = $oUser->NO;
					$oTransferArg->USER_ID_DEST = $sCleanedUserId;
					$oInsertTransferRst = executeQuery('angeclub.insertTmpAdminComUserTransferred', $oTransferArg);
					// echo '<BR>핸폰 번호 고유성 확인된 회원 정보의 ID 변경<BR>';
					// var_dump($oTransferArg);
					// echo '<BR><BR>';
					unset($oTransferArg);
					unset($oInsertRst);
				}
				$oUser->USER_ID = $sCleanedUserId;
				$sCleanedEmail = $this->_validateXeEmail($oUser->EMAIL);
				if($oUser->EMAIL != $sCleanedEmail)
				{
					echo 'invalid eamil: '.$oUser->EMAIL.' has been corrected to '.$sCleanedEmail.'<BR>';
					$oUser->EMAIL = $sCleanedEmail;
				}
				$this->_insertComUserCleaned($oUser);
			}
			elseif($nDuplication>1)  // 다수의 동일 핸폰 번호가 등록된 회원 정보를 정리하고 등록
			{
				if($oDupRst->data[$nDuplication-1]->NO == $oUser->NO)
				{
					// echo ': compress '.$nDuplication.'-times duplicated mobile info!<BR>';
					// echo '<BR>';
					$oLatestMemberInfo = $oDupRst->data[$nDuplication-1];
					$aTmpUserId = [];
					$nFinalChoosedNo = null;
					$sFinalChoosedUserId = null;
					foreach($oDupRst->data as $nDupIdx=>$oDupUser)
					{
						if(strpos($oDupUser->USER_ID, '@') === false)  // USER_ID가 이메일이 아니면
						{ 
							$nFinalChoosedNo = $oDupUser->NO;
							$sFinalChoosedUserId = $oDupUser->USER_ID;
						}
						$aTmpUserId[$oDupUser->NO] = $oDupUser->USER_ID;
					}

					$bVeryComplexSituation = FALSE;
					if(!$nFinalChoosedNo && !$sFinalChoosedUserId)  // 등록된 모든 ID가 이메일 일때
					{
						$nFinalChoosedNo = $oLatestMemberInfo->NO;
						$aUserId = explode('@', $oLatestMemberInfo->USER_ID);
						$sFinalChoosedUserId = $this->_checkUserIdUniqueness($aUserId[0]);
						unset($aUserId);
						$sCleanedUserId = $this->_cleanUserId($sFinalChoosedUserId, $oLatestMemberInfo->EMAIL, $oLatestMemberInfo->PHONE_2);
						// 최종 처리된 ID가 원본 ID와 달라서 ALIAS에 추가함
						$oTransferArg = new stdClass();
						$oTransferArg->NO_SOURCE = $nFinalChoosedNo;
						$oTransferArg->USER_ID_SOURCE = $oLatestMemberInfo->USER_ID;
						$oTransferArg->NO_DEST = $oLatestMemberInfo->NO;
						$oTransferArg->USER_ID_DEST = $sCleanedUserId;
						$oInsertTransferRst = executeQuery('angeclub.insertTmpAdminComUserTransferred', $oTransferArg);
						// echo '<BR>중복 핸폰 번호이며 등록된 모든 ID가 이메일인 회원 정보의 ID 변경<BR>';
						// var_dump($oTransferArg);
						// echo '<BR><BR>';
						unset($oTransferArg);
						unset($oInsertRst);
						$bVeryComplexSituation = TRUE;
					}
					else
					{
						$sCleanedUserId = $this->_cleanUserId($sFinalChoosedUserId, $oLatestMemberInfo->EMAIL, $oLatestMemberInfo->PHONE_2);
						if($sFinalChoosedUserId != $sCleanedUserId)
						{
							// 최종 처리된 ID가 원본 ID와 달라서 ALIAS에 추가함
							$oTransferArg = new stdClass();
							$oTransferArg->NO_SOURCE = $nFinalChoosedNo;
							$oTransferArg->USER_ID_SOURCE = $sFinalChoosedUserId;
							$oTransferArg->NO_DEST = $nFinalChoosedNo;
							$oTransferArg->USER_ID_DEST = $sCleanedUserId;
							$oInsertTransferRst = executeQuery('angeclub.insertTmpAdminComUserTransferred', $oTransferArg);
							// echo '<BR>중복 핸폰 번호이며 등록된 모든 ID가 이메일은 아니지만 ID 검사 실패한 회원 정보의 ID 변경<BR>';
							// var_dump($oTransferArg);
							// echo '<BR><BR>';
							unset($oTransferArg);
							unset($oInsertRst);
							$bVeryComplexSituation = TRUE;
						}
					}
					$sCleanedEmail = $this->_validateXeEmail($oLatestMemberInfo->EMAIL);
					if($oLatestMemberInfo->EMAIL != $sCleanedEmail)
					{
						echo 'invalid eamil: '.$oLatestMemberInfo->EMAIL.' has been corrected to '.$sCleanedEmail.'<BR>';
						$oLatestMemberInfo->EMAIL = $sCleanedEmail;
					}
					$oLatestMemberInfo->NO = $nFinalChoosedNo;
					$oLatestMemberInfo->USER_ID = $sCleanedUserId;
					$this->_insertComUserCleaned($oLatestMemberInfo);
					unset($nFinalChoosedNo, $sFinalChoosedUserId, $aFinalNoAlias,$aFinalUserIdAlias);

					// 집계된 alias NO USER_ID 등록
					unset($aTmpUserId[$oLatestMemberInfo->NO]); // transferred tbl에 sFinalChoosedUserId 중복 등록 방지
					$oTransferArg = new stdClass();
					foreach($aTmpUserId as $nNo=>$sUserId)
					{
						$oTransferArg->NO_SOURCE = $nNo;
						$oTransferArg->USER_ID_SOURCE = $sUserId;
						$oTransferArg->NO_DEST = $oLatestMemberInfo->NO;
						$oTransferArg->USER_ID_DEST = $oLatestMemberInfo->USER_ID;
						$oInsertTransferRst = executeQuery('angeclub.insertTmpAdminComUserTransferred', $oTransferArg);
						// echo '<BR>중복 핸폰 번호의 ID ALIAS 등록<BR>';
						// var_dump($oTransferArg);
						// echo '<BR>';
						unset($oInsertRst);
					}
					unset($aTmpNo, $aTmpUserId, $oTransferArg, $oLatestMemberInfo);
					
					if($bVeryComplexSituation)
					{
						;//echo 'VeryComplexSituation<BR>';
						// exit;
					}
					// exit;
				}
				else
					; // echo ': pass '.$nDuplication.'-times duplicated mobile '.$oUser->PHONE_2.' info!<BR>';
				unset($oDupRst);
			}
		}
		unset($oArgs);
		FileHandler::writeFile($sSeqLogFilePath, ++$nCurPage);
		echo '<BR><BR>succeed!<BR>wait for DB proc completion!<BR><BR>';
	}
/**
 * @brief 중복 핸폰 번호 목록을 별도 테이블로 추출
 */
	private function _retreiveDuplicatedMobileInfo()
	{
		// $oInsertArgs->NO = $oDupUser->NO;  // ["NO"]=> int(1) 
		// $oInsertArgs->USER_ID = $oDupUser->USER_ID;  // ["USER_ID"]=> string(10) "seunghee13" 
		// $oInsertArgs->USER_NM = $oDupUser->USER_NM;  // ["USER_NM"]=> string(9) "백승희" 
		// $oInsertArgs->NICK_NM = $oDupUser->NICK_NM;  // ["NICK_NM"]=> string(12) "돌핀엄마" 
		// $oInsertArgs->PASSWORD = $oDupUser->PASSWORD;  // ["PASSWORD"]=> string(77) "sha256:1000:yyE54pLeEC4FBzbBnwzbRo1lF92UigE4:RRkphOoLqQQuhYxP+ylQ807I8M7uj+QE"  
		// $oInsertArgs->BIRTH = $oDupUser->BIRTH;  // ["BIRTH"]=> string(8) "19910925" 
		// $oInsertArgs->ZONE_CODE = $oDupUser->ZONE_CODE;  // ["ZONE_CODE"]=> string(0) "" 
		// $oInsertArgs->ZIP_CODE = $oDupUser->ZIP_CODE;  // ["ZIP_CODE"]=> string(6) "365831" 
		// $oInsertArgs->ADDR = $oDupUser->ADDR;  // ["ADDR"]=> string(29) "충북 진천군 광혜원면" 
		// $oInsertArgs->ADDR_DETAIL = $oDupUser->ADDR_DETAIL;  // ["ADDR_DETAIL"]=> string(46) "광혜원리 코아루아파트 107동 1102호" 
		// $oInsertArgs->PHONE_2 = $oDupUser->PHONE_2;  // ["PHONE_2"]=> string(11) "01091797386" 
		// $oInsertArgs->EMAIL = $oDupUser->EMAIL;  // ["EMAIL"]=> string(22) "babydolphin9@naver.com" 
		// $oInsertArgs->SEX_GB = $oDupUser->SEX_GB;   // ["SEX_GB"]=> string(1) "F" 
		// $oInsertArgs->CLUB_INT = $oDupUser->CLUB_INT;  // ["CLUB_INT"]=> NULL 
		// $oInsertArgs->REG_DT = $oDupUser->REG_DT;  // ["REG_DT"]=> string(19) "2012-01-26 21:54:07" 
		// $oInsertArgs->CLUB_REG_DT = $oDupUser->CLUB_REG_DT;  // ["CLUB_REG_DT"]=> NULL 
		// $oInsertArgs->FINAL_LOGIN_DT = $oDupUser->FINAL_LOGIN_DT;  // ["FINAL_LOGIN_DT"]=> string(19) "2018-03-21 13:48:08" 
		// $oInsertArgs->PREGNENT_FL = $oDupUser->PREGNENT_FL;  // ["PREGNENT_FL"]=> string(1) "N" 
		// $oInsertArgs->CONTACT_ID = $oDupUser->CONTACT_ID;  // ["CONTACT_ID"]=> string(0) "" 
		// $oInsertArgs->CARE_AREA = $oDupUser->CARE_AREA;  // ["CARE_AREA"]=> NULL 
		// $oInsertArgs->CARE_CENTER = $oDupUser->CARE_CENTER;  // ["CARE_CENTER"]=> string(0) "" 
		// $oInsertArgs->CENTER_CNT = $oDupUser->CENTER_CNT;  // ["CENTER_CNT"]=> int(0) 
		// $oInsertArgs->CLUBEDU_CNT = $oDupUser->CLUBEDU_CNT;  // ["CLUBEDU_CNT"]=> NULL 
		// $oInsertArgs->EN_ANGE_EMAIL_FL = $oDupUser->EN_ANGE_EMAIL_FL;  // ["EN_ANGE_EMAIL_FL"]=> string(1) "Y"
		// $oInsertArgs->EN_ANGE_SMS_FL = $oDupUser->EN_ANGE_SMS_FL;  // ["EN_ANGE_SMS_FL"]=> string(1) "Y" 
		// $oInsertArgs->EN_CLUB_SPONSOR_FL = $oDupUser->EN_CLUB_SPONSOR_FL;  // ["EN_CLUB_SPONSOR_FL"]=> string(1) "Y" 
		// $oInsertArgs->EN_ANGE_ADDR_FL = $oDupUser->EN_ANGE_ADDR_FL;  // ["EN_ANGE_ADDR_FL
		ini_set('memory_limit', '1024M');  // php.ini 512M
		set_time_limit(360);  // sec

		// 회원 정보에서 중복된 핸드폰 번호 발견하면 중복 번호 테이블에 기록
		$sSeqLogFilePath = './files/angeclub/com_user_duplicated_mobile_seq.txt';
		$sSeqLogFileContent = FileHandler::readFile($sSeqLogFilePath);
		if($sSeqLogFileContent)
			$nCurPage = (int)$sSeqLogFileContent;
		else
			$nCurPage = 1;

		$oArgs = new stdClass();
		$oArgs->page = $nCurPage;
		$oRst = executeQueryArray('angeclub.getTmpAdminComUserPagination', $oArgs);
		unset($oArgs);
		echo count($oRst->data).' records has been detected<BR>';

		$oArgs = new stdClass();
		$oInsertArgs = new stdClass();
		$nCnt = 1;
		foreach($oRst->data as $nIdx=>$oUser)
		{
			if(strlen($oUser->PHONE_2) < 9)  // 0101234567
				continue;
			// echo $nCnt++.' - '.$oUser->NO.' - '.$oUser->PHONE_2.'<BR>';
			$oArgs->PHONE_2 = $oUser->PHONE_2;
			$oDupRst = executeQueryArray('angeclub.getTmpAdminComUserDuplicatedMobile', $oArgs);
			$nDuplication = count($oDupRst->data);
			if($nDuplication>1)
			{
				echo ':'.$nDuplication.'-times duplicated mobile found!<BR>';
				foreach($oDupRst->data as $nDupIdx=>$oDupUser)
				{
					$oInsertRst = executeQuery('angeclub.insertTmpAdminComUserDuplicatedMobile', $oDupUser);
					if(!$oInsertRst->toBool())
					{
						if(strpos($oInsertRst->message, 'Duplicate entry') === false)
						{  
							var_Dump($oInsertRst->message);
							echo 'error occured!!!';
							exit;
						} 
					}
				}
			}
		}
		unset($oArgs);
		FileHandler::writeFile($sSeqLogFilePath, ++$nCurPage);
	}
/**
 * @brief 
 */
	public function procAngeclubAdminDelete()
	{
		$module_srl = Context::get('module_srl');
		// delete docs belongint to the module
		$output = $this->_deleteAllDocsByModule( $module_srl );
		if( !$output->toBool() )
			return $output;

		// delete designated module
		
		// Get an original
		$oModuleController = getController('module');
		$output = $oModuleController->deleteModule($module_srl);
		if(!$output->toBool()) 
			return $output;

		$this->add('module','page');
		$this->add('page',Context::get('page'));
		$this->setMessage('success_deleted');

		$returnUrl = Context::get('success_return_url') ? Context::get('success_return_url') : getNotEncodedUrl('', 'module', 'admin', 'act', 'dispAngemomboxAdminIndex');
		$this->setRedirectUrl($returnUrl);
	}
/**
 * @brief 
 **/
	public function procAngeclubAdminConfig()
	{
        $oArgs = new stdClass();
		$sMemberAddrFieldName = Context::get('member_addr_field_name');
		if(strlen($sMemberAddrFieldName))
			$oArgs->member_addr_field_name = $sMemberAddrFieldName;
        $sConnectedMomboxMid = Context::get('connected_mombox_mid');
        if(strlen($sConnectedMomboxMid))
            $oArgs->connected_mombox_mid = $sConnectedMomboxMid;
        $sPasswordPrefix = Context::get('password_prefix');
        if(strlen($sPasswordPrefix))
            $oArgs->password_prefix = $sPasswordPrefix;
		$oRst = $this->_saveModuleConfig($oArgs);
		if(!$oRst->toBool())
			$this->setMessage('error_occured');
		else
			$this->setMessage('success_updated');
		$this->setRedirectUrl(getNotEncodedUrl('', 'module', Context::get('module'), 'act', 'dispAngeclubAdminConfig'));
	}
/**
 * @brief arrange and save module config
 **/
	private function _saveModuleConfig($oArgs)
	{
		$oModuleControll = getController('module');
		return $oModuleControll->insertModuleConfig('angeclub', $oArgs);
	}
/**
 * @brief module module
 */
	public function procAngeclubAdminUpdate()
	{
		$this->procAngeclubAdminInsert();
	}
/**
 * @brief add module
 */
	public function procAngeclubAdminInsert()
	{
		$oArgs = Context::getRequestVars();
		$oArgs->module = 'angeclub';
		$oArgs->mid = $oArgs->page_name;	//because if mid is empty in context, set start page mid
		unset($oArgs->page_name);
		if($oArgs->use_mobile != 'Y') 
			$oArgs->use_mobile = '';
		$oRst = $this->_saveConfigByMid($oArgs);
		unset($oArgs);
		if(!$oRst->toBool()) 
			return $oRst;
		$this->add("page", Context::get('page'));
		$this->add('module_srl', $oRst->get('module_srl'));
		$returnUrl = Context::get('success_return_url') ? Context::get('success_return_url') : getNotEncodedUrl('', 'module', 'admin', 'module_srl', $oRst->get('module_srl'), 'act', 'dispAngeclubAdminModDetail');
		$this->setRedirectUrl($returnUrl);
	}
/**
 * @brief add module
 */
	private function _saveConfigByMid($oArgs)
	{
		$args = $oArgs;
		if($args->module_srl)
		{
			$oModuleModel = getModel('module');
			$module_info = $oModuleModel->getModuleInfoByModuleSrl($args->module_srl);
			unset($module_info->is_skin_fix); // 기본 스킨 고정을 해제함
			unset($module_info->is_mskin_fix); // 기본 스킨 고정을 해제함
			if($module_info->module_srl != $args->module_srl)
				unset($args->module_srl);
			else
			{
				foreach($args as $key=>$val)
					$module_info->{$key} = $val;
				$args = $module_info;
			}
		}
		$oModuleController = getController('module');
		// Insert/update depending on module_srl
		if(!$args->module_srl)
			$output = $oModuleController->insertModule($args);
		else
			$output = $oModuleController->updateModule($args);
		return $output;
	}
}